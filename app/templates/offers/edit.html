{% extends "base.html" %}
{% import "_macros.html" as ui %}
{% block title %}Offer {{ offer.id }}{% endblock %}



{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-0">
      {% if offer.prop %}
        {{ offer.prop.full_address or offer.prop.address }}
      {% else %}
        Offer
      {% endif %}
    </h2>
    <div class="small text-muted">
      {% if offer.lead %}
        Seller: {{ offer.lead.seller_first_name }} {{ offer.lead.seller_last_name or '' }} ·
        Status: {{ ui.status_badge(offer.lead.lead_status) }}
      {% endif %}
    </div>
  </div>
  <div>
    <a class="btn btn-outline-light" href="{{ url_for('offers.list_offers', lead_id=offer.lead_id) }}">Back to Offers</a>
  </div>
</div>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="mb-0">Offer #{{ offer.id }}</h3>
    <div class="d-flex gap-2">
      {% if offer.property_id %}
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('main.property_detail', property_id=offer.property_id) }}">View Property</a>
      {% endif %}
      {% if offer.contact_id %}
        <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('contacts.view_contact', contact_id=offer.contact_id) }}">View Contact</a>
      {% endif %}
    </div>
  </div>

  <form method="POST" action="{{ url_for('offers.save_offer', offer_id=offer.id) }}" id="offerForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

    <div class="row g-3">
      <!-- Deal meta -->
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header">Deal</div>
          <div class="card-body">
            <div class="mb-2">
              <label class="form-label">Deal kind</label>
              <select class="form-select form-select-sm" name="deal_kind" id="deal_kind">
                <option value="" {{ 'selected' if not offer.deal_kind else '' }}>—</option>
                <option value="Flip" {{ 'selected' if offer.deal_kind=='Flip' else '' }}>Flip</option>
                <option value="Rental" {{ 'selected' if offer.deal_kind=='Rental' else '' }}>Rental</option>
              </select>
            </div>
            <div class="mb-2">
              <label class="form-label">Deal type</label>
              <div class="d-flex flex-wrap gap-2">
                {% for t in DealType %}
                <label class="btn btn-sm {{ 'btn-primary' if offer.deal_type==t else 'btn-outline-primary' }}">
                  <input class="d-none" type="radio" name="deal_type" value="{{ t.value }}" {{ 'checked' if offer.deal_type==t else '' }}>
                  {{ t.value }}
                </label>
                {% endfor %}
              </div>
            </div>

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">ARV</label>
                <input class="form-control form-control-sm money" name="arv" id="arv" value="{{ offer.arv or '' }}">
              </div>
              <div class="col-6">
                <label class="form-label">Estimated Market Rent</label>
                <input class="form-control form-control-sm money" name="market_rent_est" id="market_rent_est" value="{{ offer.market_rent_est or '' }}">
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">Condition (1–10)</label>
              <input class="form-control form-control-sm" name="condition_1_10" id="condition" type="number" min="1" max="10" value="{{ offer.condition_1_10 or '' }}">
              <div class="small text-muted mt-1">
                Real value = ARV × (1 − 0.045 × (10 − condition))<br>
                Repairs (auto) = ARV − Real value
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Mortgage & PITI -->
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header">Mortgage & PITI</div>
          <div class="card-body">
            <div class="form-check mb-2">
              <input class="form-check-input" type="checkbox" name="has_mortgage" id="has_mortgage" {{ 'checked' if offer.has_mortgage else '' }}>
              <label class="form-check-label" for="has_mortgage">There is an existing mortgage</label>
            </div>
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Mortgage Balance</label>
                <input class="form-control form-control-sm money" name="mortgage_balance" id="mortgage_balance" value="{{ offer.mortgage_balance or '' }}">
              </div>
              <div class="col-6">
                <label class="form-label">Mortgage Payment (mo)</label>
                <input class="form-control form-control-sm money" name="mortgage_payment" id="mortgage_payment" value="{{ offer.mortgage_payment or '' }}">
              </div>
              <div class="col-4">
                <label class="form-label">Rate %</label>
                <input class="form-control form-control-sm" name="interest_rate" id="interest_rate" value="{{ offer.interest_rate or '' }}">
              </div>
              <div class="col-4">
                <label class="form-label">Taxes (mo)</label>
                <input class="form-control form-control-sm money" name="monthly_taxes" id="monthly_taxes" value="{{ offer.monthly_taxes or '' }}">
              </div>
              <div class="col-4">
                <label class="form-label">Insurance (mo)</label>
                <input class="form-control form-control-sm money" name="monthly_insurance" id="monthly_insurance" value="{{ offer.monthly_insurance or '' }}">
              </div>
              <div class="col-12">
                <div class="alert alert-light border mt-2 mb-0">
                  <strong>PITI (auto):</strong> <span id="piti_disp">—</span>
                </div>
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">Reinstatement Amount</label>
              <input class="form-control form-control-sm money" name="reinstatement_amount" id="reinstatement_amount" value="{{ offer.reinstatement_amount or '' }}">
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing / Offers -->
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header">Pricing & Offers</div>
          <div class="card-body">
            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Repairs (Flip)</label>
                <input class="form-control form-control-sm money" name="repairs_flip" id="repairs_flip" value="{{ offer.repairs_flip or '' }}">
              </div>
              <div class="col-6">
                <label class="form-label">Repairs (Rental)</label>
                <input class="form-control form-control-sm money" name="repairs_rental" id="repairs_rental" value="{{ offer.repairs_rental or '' }}">
              </div>
            </div>

            <hr class="my-2">

            <div class="row g-2">
              <div class="col-6">
                <label class="form-label">Investor Cash Price</label>
                <input class="form-control form-control-sm money" name="investor_cash_price" id="investor_cash_price" value="{{ offer.investor_cash_price or '' }}">
              </div>
              <div class="col-6">
                <label class="form-label">End Buyer Sale Price (auto)</label>
                <input class="form-control form-control-sm money" name="end_buyer_price" id="end_buyer_price" value="{{ offer.end_buyer_price or '' }}">
                <div class="small text-muted">= ARV × 0.90 − Repairs</div>
              </div>
              <div class="col-6">
                <label class="form-label">My Cash Offer (auto)</label>
                <input class="form-control form-control-sm money" name="my_cash_offer" id="my_cash_offer" value="{{ offer.my_cash_offer or '' }}">
                <div class="small text-muted">= ARV × 0.64 − Repairs</div>
              </div>
              <div class="col-6">
                <label class="form-label">Investor Cash Offer (auto)</label>
                <input class="form-control form-control-sm money" id="investor_cash_offer_auto" readonly>
                <div class="small text-muted">= ARV × 0.70 − Repairs</div>
              </div>
              <div class="col-6">
                <label class="form-label">Cash for Equity</label>
                <input class="form-control form-control-sm money" name="cash_for_equity" id="cash_for_equity" value="{{ offer.cash_for_equity or '' }}">
              </div>
              <div class="col-6">
                <label class="form-label">Sales Closing Costs (auto)</label>
                <input class="form-control form-control-sm money" id="sales_closing_costs" readonly>
                <div class="small text-muted">= ARV × 0.05</div>
              </div>
            </div>

            <div class="mt-2">
              <label class="form-label">Potential Wholesale Fee (Owner Finance)</label>
              <input class="form-control form-control-sm money" id="wholesale_fee_of" readonly>
              <div class="small text-muted">= EndBuyer − CashOffer − CashForEquity × 0.9</div>
            </div>

            <div class="mt-2">
              <label class="form-label">Potential Wholesale Fee (Subject To)</label>
              <input class="form-control form-control-sm money" id="wholesale_fee_subto" readonly>
              <div class="small text-muted">= (Real FMV × 0.18) − Reinstatement − CashForEquity</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="card my-3">
      <div class="card-header">Notes</div>
      <div class="card-body">
        <textarea class="form-control" rows="3" name="notes">{{ offer.notes or '' }}</textarea>
      </div>
    </div>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Offer #{{ offer.id }}</h3>
  <div class="d-flex gap-2">
    {% if offer.property_id %}
      <a class="btn btn-sm btn-outline-secondary"
         href="{{ url_for('main.property_detail', property_id=offer.property_id) }}">
        View Property
      </a>
    {% endif %}
    {% if offer.lead_id %}
      <a class="btn btn-sm btn-outline-secondary"
         href="{{ url_for('main.lead_detail', lead_id=offer.lead_id) }}">
        View Contact
      </a>
    {% endif %}
  </div>
</div>


  <!-- Actions -->
  <div class="row g-3 mt-4">
    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header">Generate Property Report</div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('offers.generate_report', offer_id=offer.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="with_seller" value="1">
            <button class="btn btn-outline-primary btn-sm">Property Report w/ seller info</button>
          </form>
          <form method="POST" action="{{ url_for('offers.generate_report', offer_id=offer.id) }}" class="d-inline ms-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <input type="hidden" name="with_seller" value="0">
            <button class="btn btn-outline-secondary btn-sm">Property Report w/o seller info</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header">Generate offer letter</div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('offers.generate_offer_letter', offer_id=offer.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-primary btn-sm">Generate</button>
          </form>
          <form method="POST" action="{{ url_for('offers.send_offer_letter', offer_id=offer.id) }}" class="d-inline ms-2">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button class="btn btn-outline-primary btn-sm">Send Offer</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-4">
      <div class="card h-100">
        <div class="card-header">Offer Status</div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-2">
            {% for s in OfferStatus %}
            <form method="POST" action="{{ url_for('offers.set_status', offer_id=offer.id) }}" class="d-inline">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" name="status" value="{{ s.value }}">
              <button class="btn btn-sm {{ 'btn-dark' if offer.offer_status==s else 'btn-outline-dark' }}">{{ s.value }}</button>
            </form>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Live math -->
<script>
function num(v){ if(!v) return 0; return parseFloat(String(v).replace(/[$, ]/g,''))||0; }
function fmt(n){ if(isNaN(n)) return '—'; return n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}); }

function recompute(){
  const arv = num(document.getElementById('arv').value);
  const cond = Math.min(10, Math.max(1, num(document.getElementById('condition').value)));

  // Real value & repairs from condition (4.5% drop per point under 10)
  const drop = 0.045 * (10 - (cond||10));
  const realValue = arv * (1 - drop);
  const repairsAuto = Math.max(0, arv - realValue);

  // Pick which repairs to apply: Flip if deal_kind=Flip, else Rental
  const dealKind = document.getElementById('deal_kind').value;
  const rFlip = num(document.getElementById('repairs_flip').value)||repairsAuto;
  const rRent = num(document.getElementById('repairs_rental').value)||repairsAuto;
  const repairs = (dealKind === 'Flip') ? rFlip : rRent;

  // PITI
  const piti = num(document.getElementById('mortgage_payment').value)
            + num(document.getElementById('monthly_taxes').value)
            + num(document.getElementById('monthly_insurance').value);
  document.getElementById('piti_disp').textContent = fmt(piti);

  // Core formulas
  const endBuyer = (arv * 0.90) - repairs;
  const myCash   = (arv * 0.64) - repairs;
  const investorCash = (arv * 0.70) - repairs;
  const closingCosts = (arv * 0.05);

  document.getElementById('end_buyer_price').value = endBuyer ? fmt(endBuyer) : '';
  document.getElementById('my_cash_offer').value   = myCash ? fmt(myCash) : '';
  document.getElementById('investor_cash_offer_auto').value = investorCash ? fmt(investorCash) : '';
  document.getElementById('sales_closing_costs').value = closingCosts ? fmt(closingCosts) : '';

  // Owner Finance wholesale fee
  const cashOffer = myCash; // using “My cash offer” in the formula you gave
  const cfeq = num(document.getElementById('cash_for_equity').value);
  const wh_of = (endBuyer - cashOffer - (cfeq * 0.90));
  document.getElementById('wholesale_fee_of').value = fmt(wh_of);

  // Subject To wholesale fee
  const reinst = num(document.getElementById('reinstatement_amount').value);
  const wh_subto = ((realValue * 0.18) - reinst - cfeq);
  document.getElementById('wholesale_fee_subto').value = fmt(wh_subto);
}

document.addEventListener('input', (e)=>{
  if(e.target.closest('#offerForm')) recompute();
});
document.addEventListener('DOMContentLoaded', recompute);
</script>
{% endblock %}
