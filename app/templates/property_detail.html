{% extends "base.html" %}
{% import "_macros.html" as ui %}
{% block title %}Property {{ prop.id }}{% endblock %}

{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h2 class="mb-0">{{ property.full_address or property.address or 'Property' }}</h2>
    {% if property.leads and property.leads[0] %}
      <div class="small text-muted">
        Lead: {{ property.leads[0].seller_first_name }} {{ property.leads[0].seller_last_name or '' }} ·
        Status: {{ ui.status_badge(property.leads[0].lead_status) }}
      </div>
    {% endif %}
  </div>
  <div>
    <a class="btn btn-outline-light" href="{{ url_for('main.leads_list', q=(property.address or '')) }}">Back to Leads</a>
  </div>
</div>

{# ---------- snapshot/raw helpers ---------- #}
{% set snap      = snapshot or {} %}
{% set meta      = snap.get('meta', {}) %}
{% set details   = snap.get('details', {}) %}
{% set cls       = snap.get('2_classification', {}) %}
{% set valinc    = snap.get('3_valuation_income', {}) %}
{% set lotbld    = snap.get('4_lot_building', {}) %}
{% set loc       = snap.get('5_location_desirability', {}) %}
{% set marketab  = snap.get('6_marketability', {}) %}
{% set rehab     = snap.get('7_rehab', {}) %}
{% set exitf     = snap.get('8_exit_flags', {}) %}
{% set market    = snap.get('market') %}

<div class="d-flex gap-2 mb-3">
  <a class="btn btn-primary" href="{{ url_for('offers.new_offer', property_id=prop.id) }}">Offer</a>
  {% if lead_for_prop %}
    <a class="btn btn-outline-secondary" href="{{ url_for('main.lead_detail', lead_id=lead_for_prop.id) }}">Contact</a>
  {% else %}
    <a class="btn btn-outline-secondary" href="{{ url_for('main.leads_list', q=prop.address) }}">Find Contact</a>
  {% endif %}
</div>

{# ---------- raw payloads from DB ---------- #}
{% set raw_all   = raw or {} %}
{% set raw_z     = raw_all.get('zillow', {}) %}
{% set raw_m     = raw_all.get('melissa', {}) %}
{% set locks     = raw_all.get('locks') or {} %}
{% set ux        = raw_all.get('user_overrides') or {} %}

{# ---------- Melissa convenience: first LookupProperty record ---------- #}
{% set m_prop_recs = (raw_m.get('LookupProperty', {}).get('Records', [])) %}
{% set m0          = (m_prop_recs[0] if m_prop_recs|length > 0 else {}) %}
{% set parcel      = m0.get('Parcel', {}) %}
{% set psize       = m0.get('PropertySize', {}) %}
{% set legal       = m0.get('Legal', {}) %}
{% set taxnode     = m0.get('Tax', {}) %}
{% set owneraddr   = m0.get('OwnerAddress', {}) %}
{% set powner      = m0.get('PrimaryOwner', {}) %}
{% set sowner      = m0.get('SecondaryOwner', {}) %}
{% set valuation   = m0.get('EstimatedValue', {}) %}
{% set propuseinfo = m0.get('PropertyUseInfo', {}) %}
{% set roominfo    = m0.get('IntRoomInfo', {}) %}
{% set m_saleinfo  = m0.get('SaleInfo', {}) %}

{# ---- Melissa "mx" extract (value/low/high/as_of) ---- #}
{% set mx = {} %}
{% set _ = mx.update({
  'value': valuation.get('EstimatedValue') 
            or taxnode.get('AssessedValueTotal')
}) %}
{% set _ = mx.update({
  'low':   valuation.get('EstimatedMinValue')
            or valuation.get('LowValue')
            or valuation.get('ValueRangeLow')
            or valuation.get('ValuationRangeLow')
}) %}
{% set _ = mx.update({
  'high':  valuation.get('EstimatedMaxValue')
            or valuation.get('HighValue')
            or valuation.get('ValueRangeHigh')
            or valuation.get('ValuationRangeHigh')
}) %}
{% set _ = mx.update({
  'as_of': valuation.get('EstimateDate')
            or valuation.get('ValuationDate')
            or valuation.get('Date')
}) %}

{# ---------- Deeds: normalize to list and pick latest ---------- #}
{% set deeds_raw = raw_m.get('LookupDeeds') or {} %}
{% set deeds_records = deeds_raw.get('Records') %}
{% if deeds_records is mapping %}
  {% set deeds_records = [deeds_records] %}
{% elif deeds_records is not sequence %}
  {% set deeds_records = [] %}
{% endif %}
{% if not deeds_records and deeds_raw.get('DocInfo') %}
  {% set deeds_records = [deeds_raw] %}
{% endif %}

{# pick latest by DocInfo.RecordingDate -> DocInfo.InstrumentDate -> Mortgage1.RecordingDate #}
{% set ns = namespace(latest=None, latest_date='') %}
{% for rec in deeds_records %}
  {% set di = rec.get('DocInfo', {}) %}
  {% set recdate = di.get('RecordingDate') or di.get('InstrumentDate') or rec.get('Mortgage1', {}).get('RecordingDate') or '' %}
  {% if recdate and recdate > ns.latest_date %}
    {% set ns.latest_date = recdate %}
    {% set ns.latest = rec %}
  {% endif %}
{% endfor %}
{% set latest      = ns.latest or {} %}
{% set latest_date = ns.latest_date %}
{% set m1          = latest.get('Mortgage1', {}) %}
{% set grantor     = latest.get('PrimaryGrantor', {}) %}
{% set grantee     = latest.get('PrimaryGrantee', {}) %}

{# ---------- Ownership (normalized fallback) ---------- #}
{% set own = snap.get('1_ownership_mortgage') or raw_all.get('ownership_mortgage') or {} %}

{# ---------- address / coords ---------- #}
{% set lat = details.get('lat') or prop.lat %}
{% set lng = details.get('lng') or prop.lng %}
{% set fulladdr = meta.get('fullAddress') or prop.full_address or prop.address or ("Property " ~ prop.id) %}

{% if raw_z %}
  <details class="mt-4">
    <summary><strong>Zillow (basics) – click to expand</strong></summary>
    <pre style="white-space: pre-wrap">{{ raw_z | tojson(indent=2) }}</pre>
  </details>

  {% set zraw = raw_z.get('raw', {}) %}
  {% if zraw.get('home') %}
    <details class="mt-3">
      <summary><strong>Zillow raw.home – click to expand</strong></summary>
      <pre style="white-space: pre-wrap">{{ zraw.get('home') | tojson(indent=2) }}</pre>
    </details>
  {% endif %}
{% endif %}

{# ---------- first photo (prefer Zillow raw.home) ---------- #}
{% set zraw = raw_z.get('raw', {}) %}
{% set home_node = (zraw.get('home') or zraw or {}) %}

{# 1) Direct image fields #}
{% set first_photo =
    home_node.get('imgSrc')
    or home_node.get('hiResImageLink')
    or home_node.get('primaryImageUrl')
    or home_node.get('imageUrl')
%}

{# 2) Arrays: photos / responsivePhotos / images / media.photos #}
{% if not first_photo %}
  {% set photos =
      home_node.get('photos')
      or home_node.get('responsivePhotos')
      or home_node.get('images')
      or home_node.get('media', {}).get('photos')
      or [] %}
  {% if photos %}
    {% if photos[0] is string %}
      {% set first_photo = photos[0] %}
    {% elif photos[0] is mapping %}
      {% set first_photo =
        photos[0].get('mixedSources', {}).get('largest')
        or photos[0].get('url')
        or photos[0].get('href')
        or photos[0].get('highResUrl')
        or photos[0].get('mediumResUrl')
        or photos[0].get('thumbnail')
      %}
    {% endif %}
  {% endif %}
{% endif %}

{# 3) Last resort: snapshot.details.raw (older saved format) #}
{% if not first_photo %}
  {% set rawd = details.get('raw', {}) %}
  {% set home2 = rawd.get('home', rawd) %}
  {% set first_photo =
    home2.get('imgSrc')
    or home2.get('primaryImageUrl')
    or home2.get('imageUrl')
  %}
{% endif %}




{# ---------- lot size display ---------- #}
{% set lot_disp = details.get('lotSizeDisplay')
  or lotbld.get('lotSizeDisplay')
  or ((psize.get('AreaLotSF') or details.get('lotSize') or lotbld.get('lotSize') or prop.lot_size) and
      (((psize.get('AreaLotSF') or details.get('lotSize') or lotbld.get('lotSize') or prop.lot_size)|int)|string ~ ' sqft')) %}

{# ---------- source/as_of badge helper ---------- #}
{% macro src_tag(field) -%}
  {%- set s = (meta.get('sources', {}).get(field) or details.get(field ~ '_source')) -%}
  {%- set d = (meta.get('as_of', {}).get(field)   or details.get(field ~ '_as_of')) -%}
  {%- if s or d -%}
    <span class="badge bg-light text-muted ms-1">
      {{ s or '—' }}{% if d %}, as of {{ d }}{% endif %}
    </span>
  {%- endif -%}
{%- endmacro %}

{# ---------- owner-occupied heuristic ---------- #}
{% set pa = (fulladdr or '')|lower|replace(',', '')|replace('.', '') %}
{% set oa = ((owneraddr.get('Address','') ~ ' ' ~ owneraddr.get('City','') ~ ' ' ~ owneraddr.get('State','') ~ ' ' ~ owneraddr.get('PostalCode',''))|lower
             |replace(',', '')|replace('.', '')) %}
{% set owner_occupied = ('Yes' if pa and oa and (pa in oa or oa in pa) else 'No') %}

{# ---------- optional est repairs from route ---------- #}
{% set est_repairs = (est_repairs if est_repairs is defined and est_repairs else '') %}

{# --- Zillow convenience nodes --- #}
{% set z_home = (raw_z.get('raw', {}).get('home') or {}) %}
{% set z_for_sale = (raw_z.get('for_sale') or z_home.get('isForSale')) %}
{% set z_status = (raw_z.get('sale_status') or z_home.get('homeStatus') or z_home.get('statusType')) %}
{% set z_list = (raw_z.get('list_price') 
                 or z_home.get('price') 
                 or z_home.get('unformattedPrice') 
                 or z_home.get('listPrice')) %}
{% set z_url = (raw_z.get('zillow_url') 
                or z_home.get('hdpUrl') 
                or z_home.get('zillowUrl') 
                or z_home.get('url')) %}

{# Prefer snapshot zestimate if present, then raw.zillow, then raw.home node #}
{% set z_zest = (valinc.get('zestimate') 
                 or raw_z.get('zestimate') 
                 or z_home.get('zestimate')) %}

{# Rent estimate can be in several shapes: snapshot.rentEstimate, raw_z, or home.rentZestimate #}
{% set z_rent = (valinc.get('rentEstimate') 
                 or raw_z.get('rent_zestimate') 
                 or z_home.get('rentZestimate') 
                 or z_home.get('rent_zestimate')) %}

{# ---------- ARV helper (Zillow → Melissa fallback) ---------- #}
{% set m_estv = valuation.get('EstimatedValue') or taxnode.get('AssessedValueTotal') %}
{% set est_arv = (z_zest if z_zest is not none else m_estv) %}

{# ---------- loaded flags ---------- #}
{% set melissa_loaded = raw_m and (m0|length > 0) %}

<div class="alert alert-info" style="white-space:nowrap">
  <strong>Raw status:</strong>
  Zillow: {{ 'yes' if raw_z else 'no' }} |
  Melissa: {{ 'yes' if raw_m else 'no' }}
</div>

<details class="mb-3">
  <summary>Show raw keys</summary>

  <div class="row g-3 mt-2">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Zillow (raw_z)</div>
        <div class="card-body p-2">
          <pre class="small bg-light p-2 border rounded" style="max-height:420px; overflow:auto;">
{{ raw_z | tojson(indent=2) }}
          </pre>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">Melissa → LookupProperty</div>
        <div class="card-body p-2">
          <pre class="small bg-light p-2 border rounded" style="max-height:420px; overflow:auto;">
{{ (raw_m.get('LookupProperty') or {}) | tojson(indent=2) }}
          </pre>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Melissa → LookupDeeds</div>
        <div class="card-body p-2">
          <pre class="small bg-light p-2 border rounded" style="max-height:420px; overflow:auto;">
{{ (raw_m.get('LookupDeeds') or {}) | tojson(indent=2) }}
          </pre>
        </div>
      </div>
    </div>
  </div>

  {% if m0 %}
  <div class="card mt-3">
    <div class="card-header">Melissa first record (m0) — top-level fields</div>
    <div class="card-body p-0">
      <table class="table table-sm mb-0">
        <thead><tr><th style="width:220px;">Key</th><th>Value (JSON)</th></tr></thead>
        <tbody>
          {% for k, v in m0.items() %}
            <tr>
              <td class="text-monospace">{{ k }}</td>
              <td><pre class="small mb-0">{{ v | tojson(indent=2) }}</pre></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <div class="mt-3">Zillow keys: {{ (raw_z.keys()|list) if raw_z else [] }}</div>
  <div>Melissa keys: {{ (raw_m.keys()|list) if raw_m else [] }}</div>
</details>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0 d-flex align-items-center">
      <span>{{ fulladdr }}</span>
      {% if raw_z.get('for_sale') %}
        <span class="badge bg-danger ms-2">For Sale</span>
        {% if raw_z.get('list_price') %}
          <span class="badge bg-light text-muted ms-1">{{ raw_z.get('list_price') | currency }}</span>
        {% endif %}
        {% if raw_z.get('zillow_url') %}
          <a class="ms-2 small" href="{{ raw_z.get('zillow_url') }}" target="_blank" rel="noopener">View on Zillow</a>
        {% endif %}
      {% elif raw_z.get('sale_status') %}
        <span class="badge bg-secondary ms-2">{{ raw_z.get('sale_status') }}</span>
      {% endif %}
    </h2>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-secondary" href="{{ url_for('main.properties_list') }}">Back</a>

      {# Melissa #}
      <form method="POST" action="{{ url_for('main.enrich_property_melissa', property_id=prop.id) }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if not melissa_loaded %}
          <button class="btn btn-sm btn-primary" type="submit">Get more info (Melissa)</button>
        {% else %}
          <button class="btn btn-sm btn-outline-primary" type="submit">Refresh Melissa</button>
        {% endif %}
      </form>

      {# Zillow #}
      <form method="POST" action="{{ url_for('main.property_refresh', property_id=prop.id) }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-outline-secondary" type="submit">Refresh Zillow</button>
      </form>

      <form method="POST" action="{{ url_for('main.delete_property', property_id=prop.id) }}" class="d-inline" onsubmit="return confirm('Delete this property?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
      </form>
    </div>
  </div>

  <!-- Hero: Photo + Map -->
  <div class="row mb-3">

<!-- Property Photo -->
<div class="col-lg-7 mb-3 mb-lg-0">
  <div class="card h-100">
    <div class="card-header">Property Photo</div>
    <div class="card-body p-0">

      {# STEP 1: start with zillow's first photo #}
      {% set photo = first_photo %}

      {# STEP 2: Reject Zillow fallback satellite images #}
      {% if photo and 'maps.googleapis.com/maps/api/staticmap' in photo %}
        {% set photo = None %}
      {% endif %}

      {# STEP 3: Normalize Zillow paths if present #}
      {% if photo %}
        {% set img_src = photo %}
        {% if img_src.startswith('//') %}
          {% set img_src = 'https:' ~ img_src %}
        {% elif img_src.startswith('/fp/') 
               or img_src.startswith('/p_') 
               or img_src.startswith('/house') %}
          {% set img_src = 'https://photos.zillowstatic.com' ~ img_src %}
        {% elif not img_src.startswith('http') %}
          {% set img_src = 'https://photos.zillowstatic.com/' ~ img_src %}
        {% endif %}
      {% endif %}

      {# STEP 4: If Zillow photo is valid, show it #}
      {% if img_src %}
        <img src="{{ img_src }}" 
             class="img-fluid w-100"
             style="object-fit:cover; max-height:420px;"
             alt="Property Photo">

      {# STEP 5: Otherwise show Google Street View #}
      {% elif GOOGLE_MAPS_API_KEY and lat and lng %}
        <img src="https://maps.googleapis.com/maps/api/streetview?size=1200x420&location={{ lat }},{{ lng }}&key={{ GOOGLE_MAPS_API_KEY }}"
             class="img-fluid w-100"
             style="object-fit:cover; max-height:420px;"
             alt="Street View">

      {# STEP 6: Last fallback #}
      {% else %}
        <div class="p-4 text-muted">No photo available.</div>
      {% endif %}

    </div>
  </div>
</div>


  <!-- Right: Map (keep as-is) -->
  <div class="col-lg-5">
    <div class="card h-100">
      <div class="card-header">Map</div>
      <div class="card-body p-0">
        {% if GOOGLE_MAPS_API_KEY and lat and lng %}
          <iframe
            width="100%"
            height="420"
            frameborder="0"
            style="border:0"
            src="https://www.google.com/maps/embed/v1/view?key={{ GOOGLE_MAPS_API_KEY }}&center={{ lat }},{{ lng }}&zoom=16&maptype=roadmap"
            allowfullscreen>
          </iframe>
        {% elif GOOGLE_MAPS_API_KEY %}
          <iframe
            width="100%"
            height="420"
            frameborder="0"
            style="border:0"
            src="https://www.google.com/maps/embed/v1/place?key={{ GOOGLE_MAPS_API_KEY }}&q={{ (fulladdr | replace(' ', '+')) }}"
            allowfullscreen>
          </iframe>
        {% else %}
          <div class="p-4 text-muted">Map unavailable (missing Google Maps API key).</div>
        {% endif %}
      </div>
    </div>
  </div>

</div>


  {# ---------- Edit / Overrides (NO LOCKS, NO LAT/LNG) ---------- #}
  <div class="card mb-3">
    <div class="card-header">Edit / Overrides</div>
    <form method="POST" action="{{ url_for('main.property_update', property_id=prop.id) }}" class="card-body">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

      <div class="row g-2">
        <div class="col-md-6">
          <label class="form-label">Full Address</label>
          <input class="form-control form-control-sm" name="full_address" value="{{ prop.full_address or '' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Beds</label>
          <input class="form-control form-control-sm" name="beds" value="{{ prop.beds if prop.beds is not none else '' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Baths</label>
          <input class="form-control form-control-sm" name="baths" value="{{ prop.baths if prop.baths is not none else '' }}">
        </div>

        <div class="col-md-2">
          <label class="form-label">Sqft</label>
          <input class="form-control form-control-sm" name="sqft" value="{{ prop.sqft if prop.sqft is not none else '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Lot Size (sf)</label>
          <input class="form-control form-control-sm" name="lot_size" value="{{ prop.lot_size if prop.lot_size is not none else '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Year Built</label>
          <input class="form-control form-control-sm" name="year_built" value="{{ prop.year_built if prop.year_built is not none else '' }}">
        </div>

        {# REMOVED lat/lng fields per request #}

        <div class="col-md-6">
          <label class="form-label">School District</label>
          <input class="form-control form-control-sm" name="school_district" value="{{ prop.school_district or '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">HOA (override)</label>
          <input class="form-control form-control-sm" name="hoa" value="{{ ux.get('hoa') or '' }}">
        </div>

        <div class="col-md-3">
          <label class="form-label">Subdivision (override)</label>
          <input class="form-control form-control-sm" name="subdivision" value="{{ ux.get('subdivision') or '' }}">
        </div>

        <div class="col-12">
          <label class="form-label">Notes</label>
          <textarea class="form-control form-control-sm" name="notes" rows="2">{{ ux.get('notes') or '' }}</textarea>
        </div>
      </div>

      <div class="mt-3">
        <button class="btn btn-sm btn-success" type="submit">Save Changes</button>
      </div>
    </form>
  </div>

  <!-- Property Info (H) -->
  <div class="card mb-3">
    <div class="card-header">Property Info (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-6"><strong>Property Address</strong> (user): {{ fulladdr }}</div>
        <div class="col-md-6"><strong>Bed/Bath</strong> (Z): {{ details.get('bedrooms') or raw_z.get('beds') or raw_z.get('bedrooms') or prop.beds or "—" }}/{{ details.get('bathrooms') or raw_z.get('baths') or raw_z.get('bathrooms') or prop.baths or "—" }}</div>
        <div class="col-md-6"><strong>Year Built</strong> (Z): {{ details.get('yearBuilt') or raw_z.get('year_built') or prop.year_built or "—" }}</div>
        <div class="col-md-6"><strong>Lot Size (sf)</strong> (M): {{ psize.get('AreaLotSF') or "—" }}</div>
        <div class="col-md-6"><strong>PropertyUseGroup</strong> (M): {{ propuseinfo.get('PropertyUseGroup') or "—" }}</div>
        <div class="col-md-6"><strong>HOA?</strong> (H): {{ ux.get('hoa') or marketab.get('hoa') or "—" }}</div>
        <div class="col-md-6"><strong>ParkingGarage</strong> (M): {{ psize.get('ParkingGarage') if psize.get('ParkingGarage') is not none else "—" }}</div>
        <div class="col-md-6"><strong>ParkingGarageArea</strong> (M): {{ psize.get('ParkingGarageArea') or "—" }}</div>
        <div class="col-md-6"><strong>BathCount</strong> (M): {{ roominfo.get('BathCount') or m0.get('BathCount') or "—" }}</div>
        <div class="col-md-6"><strong>BathPartialCount</strong> (M): {{ roominfo.get('BathPartialCount') or m0.get('BathPartialCount') or "—" }}</div>
      </div>
    </div>
  </div>

  <!-- Ownership (H) -->
  <div class="card mb-3">
    <div class="card-header">Ownership (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-6"><strong>Primary Owner</strong> (M): {{ powner.get('Name1Full') }}{% if powner.get('Name2Full') %} / {{ powner.get('Name2Full') }}{% endif %}</div>
        <div class="col-md-6"><strong>Secondary Owner</strong> (M): {{ sowner.get('Name3Full') or "—" }}</div>
        <div class="col-md-6"><strong>Owner's Address</strong> (M): {{ owneraddr.get('Address') }} {{ owneraddr.get('Address2') }} {{ owneraddr.get('City') }} {{ owneraddr.get('State') }} {{ owneraddr.get('PostalCode') }}</div>
        <div class="col-md-6"><strong>Owner Occupied</strong> (C): {{ owner_occupied }}</div>
      </div>
    </div>
  </div>

  <!-- Tax (H) -->
  <div class="card mb-3">
    <div class="card-header">Tax (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-4"><strong>YearAssessed</strong> (M): {{ taxnode.get('YearAssessed') or "—" }}</div>
        <div class="col-md-4"><strong>AssessedValueTotal</strong> (M): {{ taxnode.get('AssessedValueTotal') | currency if taxnode.get('AssessedValueTotal') is not none else "—" }}</div>
        <div class="col-md-4"><strong>TaxBilledAmount</strong> (M): {{ taxnode.get('TaxBilledAmount') | currency if taxnode.get('TaxBilledAmount') is not none else "—" }}</div>
      </div>
    </div>
  </div>

  <!-- Title (H) -->
  <div class="card mb-3">
    <div class="card-header">Title (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-12"><strong>LegalDescription</strong> (M): {{ legal.get('LegalDescription') or "—" }}</div>
        <div class="col-md-4"><strong>County</strong> (M): {{ legal.get('County') or parcel.get('County') or "—" }}</div>
        <div class="col-md-4"><strong>Subdivision</strong> (M): {{ ux.get('subdivision') or legal.get('Subdivision') or "—" }}</div>
        <div class="col-md-2"><strong>Block1</strong> (M): {{ legal.get('Block1') or "—" }}</div>
        <div class="col-md-2"><strong>LotNumber1</strong> (M): {{ legal.get('LotNumber1') or "—" }}</div>
      </div>
    </div>
  </div>

  <!-- Mortgage Info (H) -->
  <div class="card mb-3">
    <div class="card-header">Mortgage Info (H)</div>
    <div class="card-body">
      {% if latest %}
        <div class="row g-2">
          <div class="col-md-6"><strong>Mortgage1 – TermDate</strong> (M): {{ m1.get('TermDate') or "—" }}</div>
          <div class="col-md-6"><strong>Mortgage1 – RecordingDate</strong> (M): {{ m1.get('RecordingDate') or "—" }}</div>
          <div class="col-md-6"><strong>Mortgage1 – Amount</strong> (M):
            {% if m1.get('Amount') %}{{ (m1.get('Amount')|int) | currency }}{% else %}—{% endif %}
          </div>
          <div class="col-md-6"><strong>Mortgage1 – LenderFullName</strong> (M): {{ m1.get('LenderFullName') or "—" }}</div>
          <div class="col-md-6"><strong>PrimaryGrantor – Name1Full</strong> (M): {{ grantor.get('Name1Full') or "—" }}</div>
          <div class="col-md-6"><strong>PrimaryGrantee – Name1Full</strong> (M): {{ grantee.get('Name1Full') or "—" }}</div>
        </div>
        <div class="text-muted small mt-2">Latest deed by RecordingDate: {{ latest_date or "—" }}</div>
      {% else %}
        <div class="text-muted">No deed records available.</div>
      {% endif %}
    </div>
  </div>

  <!-- Sale Info (H) -->
  <div class="card mb-3">
    <div class="card-header">Sale Info (H)</div>
    <div class="card-body">
      {% set sale_last_date = m_saleinfo.get('AssessorLastSaleDate') %}
      {% set sale_last_amt  = m_saleinfo.get('AssessorLastSaleAmount') %}
      <div class="row g-2">
        <div class="col-md-6"><strong>AssessorLastSaleDate</strong> (M): {{ sale_last_date or "—" }}</div>
        <div class="col-md-6"><strong>AssessorLastSaleAmount</strong> (M): {{ sale_last_amt | currency if sale_last_amt is not none else "—" }}</div>
      </div>
      <hr class="my-2">
      <div class="row g-2">
        <div class="col-md-6">
          <strong>Zillow Status</strong>:
          {% if z_for_sale %}
            <span class="badge bg-warning text-dark">For Sale</span>
            {% if z_list %} <span class="ms-1">{{ z_list | currency }}</span>{% endif %}
          {% elif z_status %}
            <span class="badge bg-light text-muted">{{ z_status }}</span>
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </div>
        <div class="col-md-6">
          <strong>Zillow Link</strong>:
          {% if z_url %}
            <a href="{{ z_url }}" target="_blank" rel="noopener">Open on Zillow</a>
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <!-- Estimates (H) -->
  <div class="card mb-3">
    <div class="card-header">Estimates (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-3"><strong>Zestimate</strong> (Z):
          {{ z_zest | currency if z_zest is not none else "—" }}
        </div>
        <div class="col-md-3"><strong>Rent Zestimate</strong> (Z):
          {{ z_rent | currency if z_rent is not none else "—" }}
        </div>
        <div class="col-md-3"><strong>Melissa AVM</strong>:
          {{ mx.get('value') | currency if mx.get('value') is not none else "—" }}
          {% if mx.get('low') and mx.get('high') %}
            <span class="text-muted"> ({{ mx.get('low')|currency }}–{{ mx.get('high')|currency }})</span>
          {% endif %}
          {% if mx.get('as_of') %}
            <span class="badge bg-light text-muted ms-1">as of {{ mx.get('as_of') }}</span>
          {% endif %}
        </div>
        <div class="col-md-3"><strong>Estimated ARV</strong> (C):
          {{ est_arv | currency if est_arv is not none else "—" }}
        </div>
      </div>
    </div>
  </div>

<div class="mt-3">
  <a href="{{ url_for('main.mls_comps', property_id=property.id) }}"
     class="btn btn-outline-primary btn-sm">
    Add MLS Comps (VA)
  </a>

  {% if property.needs_mls_review %}
    <span class="badge bg-warning text-dark ms-2">Needs MLS Review</span>
  {% elif property.evaluation_stage == 3 %}
    <span class="badge bg-success ms-2">MLS ARV Complete</span>
  {% else %}
    <form method="POST"
          action="{{ url_for('main.mark_needs_mls_review', property_id=property.id) }}"
          class="d-inline ms-2">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <button type="submit" class="btn btn-sm btn-outline-warning">
        Mark as Needs MLS Review
      </button>
    </form>
  {% endif %}
</div>


  {# ---- AI ARV CARD ---- #}
  {% if arv_pack and arv_pack.arv is not none %}
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>AI ARV (from comps)</span>
        <span class="badge bg-light text-muted">{{ arv_notes }}</span>
      </div>
      <div class="card-body">
        <div class="row g-2">
          <div class="col-md-3"><strong>ARV</strong>: {{ arv_pack.arv | currency }}</div>
          <div class="col-md-3">
            <strong>Range</strong>:
            {{ arv_pack.low | currency if arv_pack.low is not none else "—" }}
            –
            {{ arv_pack.high | currency if arv_pack.high is not none else "—" }}
          </div>
          <div class="col-md-6">
            <span class="text-muted small">
              Used comps:
              {% if arv_pack.used and (ai_comps or comps_list) %}
                {% set src = ai_comps if ai_comps else comps_list %}
                {% for i in arv_pack.used %}
                  {% set c = src[i] if i < src|length else None %}
                  {% if c %}
                    <span class="me-2">{{ (c._addr_line or c.address) or ('Comp ' ~ i) }}</span>
                  {% endif %}
                {% endfor %}
              {% else %}—{% endif %}
              {% if arv_pack and arv_pack.why %}
                <div class="mt-2 small text-muted">
                  <strong>Why:</strong> {{ arv_pack.why }}
                </div>
              {% endif %}
            </span>
          </div>
        </div>
      </div>
    </div>
  {% elif arv_notes %}
    <div class="alert alert-secondary small mb-3">{{ arv_notes }}</div>
  {% endif %}

  <div class="row g-2 mt-2">
    <div class="col-md-3"><strong>Estimated Melissa Value</strong> (M): {{ valuation.get('EstimatedValue') | currency if valuation.get('EstimatedValue') is not none else (taxnode.get('AssessedValueTotal') | currency if taxnode.get('AssessedValueTotal') is not none else "—") }}</div>
    <div class="col-md-3"><strong>Estimated ARV</strong> (C): {{ est_arv | currency if est_arv is not none else "—" }}</div>
  </div>

  {# ---------- AI-select comps trigger (still useful) ---------- #}
  <form method="POST" action="{{ url_for('main.comps_ai_select', property_id=prop.id) }}" class="d-inline">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <input type="hidden" name="k" value="6">
    <button class="btn btn-sm btn-success" type="submit">AI pick best comps</button>
  </form>

  {# ---------- Comps (just show them, no rule UI) ---------- #}
  {% set comps = comps_list or [] %}

  <div class="card mb-4 mt-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Comps</span>
      <span class="badge bg-light text-muted">{{ comps|length }} matches</span>
    </div>
    <div class="card-body p-0">
      {% if comps %}
        <table class="table table-sm mb-0 align-middle">
          <thead>
            <tr>
              <th style="width:30%;">Address</th>
              <th style="width:14%;">Sale Date</th>
              <th style="width:14%;">Price</th>
              <th style="width:8%;">Beds</th>
              <th style="width:8%;">Baths</th>
              <th style="width:10%;">Sqft</th>
              <th style="width:8%;">year built</th>
              <th style="width:8%;">distance</th>
            </tr>
          </thead>
          <tbody>
            {% for c in comps[:10] %}
              {% set parts = [] %}
              {% if c.address1 %}{% set _ = parts.append(c.address1) %}{% endif %}
              {% if c.city %}{% set _ = parts.append(c.city) %}{% endif %}
              {% if c.state %}{% set _ = parts.append(c.state) %}{% endif %}
              {% if c.postalcode or c.postalCode %}{% set _ = parts.append(c.postalcode or c.postalCode) %}{% endif %}
              {% set label = c.address or c._addr_line or parts|join(', ') %}

              <tr>
                <td class="small">
                  {% if c.zillow_url %}
                    <a href="{{ c.zillow_url }}" target="_blank" rel="noopener noreferrer">{{ label }}</a>
                  {% else %}
                    {{ label or '—' }}
                  {% endif %}
                </td>

                <td class="small">{{ c.saleDate or '—' }}</td>
                <td class="small">{% if c.price is number %}{{ c.price|currency }}{% else %}—{% endif %}</td>
                <td class="small">{{ c.beds if c.beds is not none else '—' }}</td>
                <td class="small">{{ c.baths if c.baths is not none else '—' }}</td>
                <td class="small">{{ c.sqft if c.sqft is not none else '—' }}</td>
                <td class="small">{{ c.yearBuilt if c.yearBuilt is not none else '—' }}</td>
                {% set dist = c.distance if c.distance not in (none, '', 0) else c.mi %}
                <td class="small">
                  {% if dist not in (none, '', 0) %}
                    {{ '%.2f'|format(dist|float) }}
                  {% else %}—{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="p-3 text-muted">No comps available.</div>
      {% endif %}
    </div>
  </div>

  {% if ai_comps %}
    <div class="card mb-4">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>AI-Selected Comps</span>
        <span class="badge bg-light text-muted">{{ ai_comps|length }} picks</span>
      </div>
      <div class="card-body p-0">
        <table class="table table-sm mb-0 align-middle">
          <thead>
            <tr>
              <th style="width:36%;">Address</th>
              <th style="width:12%;">Sale Date</th>
              <th style="width:12%;">Price</th>
              <th style="width:8%;">Beds</th>
              <th style="width:8%;">Baths</th>
              <th style="width:10%;">Sqft</th>
              <th style="width:6%;">Distance</th>
              <th style="width:8%;">Score</th>
            </tr>
          </thead>
          <tbody>
          {% for c in ai_comps %}
            {% set price = c.get('price') %}
            {% set ai    = c.get('ai_score') %}
            {% set sc    = c.get('score') %}
            {% set why   = c.get('ai_reason') or c.get('reason') %}
            <tr>
              <td class="small">
                {% set label = c.get('address') or c.get('_addr_line') %}
                {% if c.get('zillow_url') %}
                  <a href="{{ c.get('zillow_url') }}" target="_blank" rel="noopener noreferrer">{{ label }}</a>
                {% else %}
                  {{ label or '—' }}
                {% endif %}
              </td>
              <td class="small">{{ c.get('saleDate') or '—' }}</td>
              <td class="small">{% if price is number %}{{ price|currency }}{% else %}—{% endif %}</td>
              <td class="small">{{ c.get('beds') if c.get('beds') is not none else '—' }}</td>
              <td class="small">{{ c.get('baths') if c.get('baths') is not none else '—' }}</td>
              <td class="small">{{ c.get('sqft')  if c.get('sqft')  is not none else '—' }}</td>
              <td class="small">{{ c.get('distance') if c.get('distance') is not none else '—' }}</td>
              <td class="small">
                {% if ai is number %}
                  {{ '%.2f'|format(ai) }}
                {% elif sc is number %}
                  {{ '%.2f'|format(sc) }}
                {% else %}
                  — 
                {% endif %}
              </td>
            </tr>
            {% if why %}
              <tr><td colspan="8" class="text-muted small ps-3">Why: {{ why }}</td></tr>
            {% endif %}
          {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}
</div>

{% endblock %}
