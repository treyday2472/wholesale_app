{% extends "base.html" %}
{% block title %}Property {{ prop.id }}{% endblock %}

{% block content %}
{# ---------- snapshot/raw helpers ---------- #}
{% set snap      = snapshot or {} %}
{% set meta      = snap.get('meta', {}) %}
{% set details   = snap.get('details', {}) %}
{% set cls       = snap.get('2_classification', {}) %}
{% set valinc    = snap.get('3_valuation_income', {}) %}
{% set lotbld    = snap.get('4_lot_building', {}) %}
{% set loc       = snap.get('5_location_desirability', {}) %}
{% set marketab  = snap.get('6_marketability', {}) %}
{% set rehab     = snap.get('7_rehab', {}) %}
{% set exitf     = snap.get('8_exit_flags', {}) %}
{% set market    = snap.get('market') %}

{# ---------- raw payloads from DB ---------- #}
{% set raw_all   = raw or {} %}
{% set raw_z     = raw_all.get('zillow', {}) %}
{% set raw_m     = raw_all.get('melissa', {}) %}
{% set raw_attom = raw_all.get('attom', {}) %}

{# ---------- Melissa convenience: first LookupProperty record ---------- #}
{% set m_prop_recs = (raw_m.get('LookupProperty', {}).get('Records', [])) %}
{% set m0          = (m_prop_recs[0] if m_prop_recs|length > 0 else {}) %}
{% set parcel      = m0.get('Parcel', {}) %}
{% set psize       = m0.get('PropertySize', {}) %}
{% set legal       = m0.get('Legal', {}) %}
{% set taxnode     = m0.get('Tax', {}) %}
{% set owneraddr   = m0.get('OwnerAddress', {}) %}
{% set powner      = m0.get('PrimaryOwner', {}) %}
{% set sowner      = m0.get('SecondaryOwner', {}) %}
{% set valuation   = m0.get('EstimatedValue', {}) %}
{% set propuseinfo = m0.get('PropertyUseInfo', {}) %}
{% set roominfo    = m0.get('IntRoomInfo', {}) %}
{% set m_saleinfo  = m0.get('SaleInfo', {}) %}

{# ---- Melissa "mx" extract (value/low/high/as_of) ---- #}
{% set mx = {} %}
{% set _ = mx.update({
  'value': valuation.get('EstimatedValue') 
            or taxnode.get('AssessedValueTotal')
}) %}
{% set _ = mx.update({
  'low':   valuation.get('EstimatedMinValue')
            or valuation.get('LowValue')
            or valuation.get('ValueRangeLow')
            or valuation.get('ValuationRangeLow')
}) %}
{% set _ = mx.update({
  'high':  valuation.get('EstimatedMaxValue')
            or valuation.get('HighValue')
            or valuation.get('ValueRangeHigh')
            or valuation.get('ValuationRangeHigh')
}) %}
{% set _ = mx.update({
  'as_of': valuation.get('EstimateDate')
            or valuation.get('ValuationDate')
            or valuation.get('Date')
}) %}


{# ATTOM extracts for convenience #}
{% set attx = raw_all.get('attom_extract') or {} %}
{% set ax   = attx.get('avm') or {} %}
{% set rx   = attx.get('rent_avm') or {} %}


{# Fallback to raw rental payload if extract not present #}
{% if not rx and (raw_attom.get('rental_avm') or {}).get('property') %}
  {% set rprop = (raw_attom.get('rental_avm').get('property') or [])[0] %}
  {% if rprop %}
    {% set rnode = rprop.get('rentalAvm', {}) %}
    {% set rx = {
      'value': rnode.get('estimatedRentalValue'),
      'low':   rnode.get('estimatedMinRentalValue'),
      'high':  rnode.get('estimatedMaxRentalValue'),
      'as_of': rnode.get('valuationDate'),
    } %}
  {% endif %}
{% endif %}




{# ---------- Deeds: normalize to list and pick latest ---------- #}
{% set deeds_raw = raw_m.get('LookupDeeds') or {} %}
{% set deeds_records = deeds_raw.get('Records') %}
{% if deeds_records is mapping %}
  {% set deeds_records = [deeds_records] %}
{% elif deeds_records is not sequence %}
  {% set deeds_records = [] %}
{% endif %}
{% if not deeds_records and deeds_raw.get('DocInfo') %}
  {% set deeds_records = [deeds_raw] %}
{% endif %}

{# pick latest by DocInfo.RecordingDate -> DocInfo.InstrumentDate -> Mortgage1.RecordingDate #}
{% set ns = namespace(latest=None, latest_date='') %}
{% for rec in deeds_records %}
  {% set di = rec.get('DocInfo', {}) %}
  {% set recdate = di.get('RecordingDate') or di.get('InstrumentDate') or rec.get('Mortgage1', {}).get('RecordingDate') or '' %}
  {% if recdate and recdate > ns.latest_date %}
    {% set ns.latest_date = recdate %}
    {% set ns.latest = rec %}
  {% endif %}
{% endfor %}
{% set latest      = ns.latest or {} %}
{% set latest_date = ns.latest_date %}
{% set m1          = latest.get('Mortgage1', {}) %}
{% set grantor     = latest.get('PrimaryGrantor', {}) %}
{% set grantee     = latest.get('PrimaryGrantee', {}) %}




{# ---------- Ownership (normalized fallback) ---------- #}
{% set own = snap.get('1_ownership_mortgage') or raw_all.get('ownership_mortgage') or {} %}

{# ---------- address / coords ---------- #}
{% set lat = details.get('lat') or prop.lat %}
{% set lng = details.get('lng') or prop.lng %}
{% set fulladdr = meta.get('fullAddress') or prop.full_address or prop.address or ("Property " ~ prop.id) %}

{# ---------- first photo (prefer Zillow/raw) ---------- #}
{% set rawd = details.get('raw', {}) %}
{% set first_photo = rawd.get('imgSrc') or rawd.get('primaryImageUrl') or rawd.get('imageUrl') %}
{% if not first_photo %}
  {% set photos = rawd.get('photos') or rawd.get('images') or (rawd.get('media', {}) if rawd else {}).get('photos') or [] %}
  {% if photos %}
    {% if photos[0] is string %}
      {% set first_photo = photos[0] %}
    {% elif photos[0] is mapping %}
      {% set first_photo = photos[0].get('url') or photos[0].get('href')
                            or (photos[0].get('mixedSources', {}) if photos[0] else {}).get('largest')
                            or photos[0].get('urlXL') or photos[0].get('urlLarge') %}
    {% endif %}
  {% endif %}
{% endif %}

{# ---------- lot size display ---------- #}
{% set lot_disp = details.get('lotSizeDisplay')
  or lotbld.get('lotSizeDisplay')
  or ((psize.get('AreaLotSF') or details.get('lotSize') or lotbld.get('lotSize') or prop.lot_size) and
      (((psize.get('AreaLotSF') or details.get('lotSize') or lotbld.get('lotSize') or prop.lot_size)|int)|string ~ ' sqft')) %}

{# ---------- source/as_of badge helper ---------- #}
{% macro src_tag(field) -%}
  {%- set s = (meta.get('sources', {}).get(field) or details.get(field ~ '_source')) -%}
  {%- set d = (meta.get('as_of', {}).get(field)   or details.get(field ~ '_as_of')) -%}
  {%- if s or d -%}
    <span class="badge bg-light text-muted ms-1">
      {{ s or '—' }}{% if d %}, as of {{ d }}{% endif %}
    </span>
  {%- endif -%}
{%- endmacro %}

{# ---------- owner-occupied heuristic ---------- #}
{% set pa = (fulladdr or '')|lower|replace(',', '')|replace('.', '') %}
{% set oa = ((owneraddr.get('Address','') ~ ' ' ~ owneraddr.get('City','') ~ ' ' ~ owneraddr.get('State','') ~ ' ' ~ owneraddr.get('PostalCode',''))|lower
             |replace(',', '')|replace('.', '')) %}
{% set owner_occupied = ('Yes' if pa and oa and (pa in oa or oa in pa) else 'No') %}

{# ---------- optional est repairs from route ---------- #}
{% set est_repairs = (est_repairs if est_repairs is defined and est_repairs else '') %}

{# ---------- ARV helper ---------- #}
{% set z_zest = valinc.get('zestimate') or raw_z.get('zestimate') %}
{% set m_estv = valuation.get('EstimatedValue') or taxnode.get('AssessedValueTotal') %}
{% set est_arv = (z_zest if z_zest is not none else m_estv) %}

{# ---------- loaded flags ---------- #}
{% set melissa_loaded = raw_m and (m0|length > 0) %}
{% set attom_loaded   = raw_attom is mapping and (raw_attom|length > 0) %}

<div class="alert alert-info" style="white-space:nowrap">
  <strong>Raw status:</strong>
  Zillow: {{ 'yes' if raw_z else 'no' }} |
  Melissa: {{ 'yes' if raw_m else 'no' }} |
  ATTOM: {{ 'yes' if attom_loaded else 'no' }}
</div>

<details class="mb-3">
  <summary>Show raw keys</summary>

  <div class="card mt-3">
    <div class="card-header">ATTOM (raw_attom)</div>
    <div class="card-body p-2">
      <pre class="small bg-light p-2 border rounded" style="max-height:420px; overflow:auto;">
{{ (raw_all.get('attom') or {}) | tojson(indent=2) }}
      </pre>
    </div>
  </div>

  <div class="row g-3 mt-2">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Zillow (raw_z)</div>
        <div class="card-body p-2">
          <pre class="small bg-light p-2 border rounded" style="max-height:420px; overflow:auto;">
{{ raw_z | tojson(indent=2) }}
          </pre>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card mb-3">
        <div class="card-header">Melissa → LookupProperty</div>
        <div class="card-body p-2">
          <pre class="small bg-light p-2 border rounded" style="max-height:420px; overflow:auto;">
{{ (raw_m.get('LookupProperty') or {}) | tojson(indent=2) }}
          </pre>
        </div>
      </div>
      <div class="card">
        <div class="card-header">Melissa → LookupDeeds</div>
        <div class="card-body p-2">
          <pre class="small bg-light p-2 border rounded" style="max-height:420px; overflow:auto;">
{{ (raw_m.get('LookupDeeds') or {}) | tojson(indent=2) }}
          </pre>
        </div>
      </div>
    </div>
  </div>

  {% if m0 %}
  <div class="card mt-3">
    <div class="card-header">Melissa first record (m0) — top-level fields</div>
    <div class="card-body p-0">
      <table class="table table-sm mb-0">
        <thead><tr><th style="width:220px;">Key</th><th>Value (JSON)</th></tr></thead>
        <tbody>
          {% for k, v in m0.items() %}
            <tr>
              <td class="text-monospace">{{ k }}</td>
              <td><pre class="small mb-0">{{ v | tojson(indent=2) }}</pre></td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  <div class="mt-3">Zillow keys: {{ (raw_z.keys()|list) if raw_z else [] }}</div>
  <div>Melissa keys: {{ (raw_m.keys()|list) if raw_m else [] }}</div>
  <div>ATTOM keys: {{ (raw_attom.keys()|list) if attom_loaded else [] }}</div>
</details>

<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">{{ fulladdr }}</h2>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-secondary" href="{{ url_for('main.properties_list') }}">Back</a>

      {# Melissa #}
      <form method="POST" action="{{ url_for('main.enrich_property_melissa', property_id=prop.id) }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% if not melissa_loaded %}
          <button class="btn btn-sm btn-primary" type="submit">Get more info (Melissa)</button>
        {% else %}
          <button class="btn btn-sm btn-outline-primary" type="submit">Refresh Melissa</button>
        {% endif %}
      </form>

    {# ATTOM — SINGLE BUTTON, VISIBLE COLOR #}
      <form method="POST" action="{{ url_for('main.enrich_attom', property_id=prop.id) }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-warning" type="submit">
          {% set raw_attom = (raw or {}).get('attom') or {} %}
          {% set attom_loaded = raw_attom.get('avm') or raw_attom.get('detail') %}
          {% if attom_loaded %}Refresh ATTOM{% else %}Get more info (ATTOM){% endif %}
        </button>
      </form>

      {# Zillow #}
      <form method="POST" action="{{ url_for('main.property_refresh', property_id=prop.id) }}" class="d-inline">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-outline-secondary" type="submit">Refresh Zillow</button>
      </form>

      <form method="POST" action="{{ url_for('main.delete_property', property_id=prop.id) }}" class="d-inline" onsubmit="return confirm('Delete this property?');">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
      </form>
    </div>
  </div>

  <!-- Hero: Photo + Map -->
  <div class="row mb-3">
    <div class="col-lg-7 mb-3 mb-lg-0">
      <div class="card h-100">
        <div class="card-header">Property Photo</div>
        <div class="card-body p-0">
          {% if first_photo %}
            <img src="{{ first_photo }}" alt="Property Photo" class="img-fluid w-100" style="object-fit:cover; max-height:420px;">
          {% elif GOOGLE_MAPS_API_KEY and lat and lng %}
            <img src="https://maps.googleapis.com/maps/api/streetview?size=1200x420&location={{ lat }},{{ lng }}&key={{ GOOGLE_MAPS_API_KEY }}"
                 alt="Street View" class="img-fluid w-100" style="object-fit:cover; max-height:420px;">
          {% else %}
            <div class="p-4 text-muted">No photo available.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="col-lg-5">
      <div class="card h-100">
        <div class="card-header">Map</div>
        <div class="card-body p-0">
          {% if GOOGLE_MAPS_API_KEY and lat and lng %}
            <iframe width="100%" height="420" frameborder="0" style="border:0"
                    src="https://www.google.com/maps/embed/v1/view?key={{ GOOGLE_MAPS_API_KEY }}&center={{ lat }},{{ lng }}&zoom=16&maptype=roadmap"
                    allowfullscreen></iframe>
          {% elif GOOGLE_MAPS_API_KEY %}
            <iframe width="100%" height="420" frameborder="0" style="border:0"
                    src="https://www.google.com/maps/embed/v1/place?key={{ GOOGLE_MAPS_API_KEY }}&q={{ (fulladdr | replace(' ', '+')) }}"
                    allowfullscreen></iframe>
          {% else %}
            <div class="p-4 text-muted">Map unavailable (missing Google Maps API key).</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

{# ---------- Activity log (supports multiple shapes) ---------- #}
{% set activity_log = (raw_all.get('log')
                       or raw_all.get('activity_log')
                       or raw_all.get('attom_log')
                       or log_entries
                       or []) %}
{% if activity_log is mapping %}
  {% set activity_log = [activity_log] %}
{% endif %}
{% set activity_log = activity_log | sort(attribute='at', reverse=True) %}

  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <span>Activity Log</span>
      <span class="badge bg-light text-muted">{{ activity_log|length }} entries</span>
    </div>
    <div class="card-body p-0">
      {% if activity_log %}
        <table class="table table-sm mb-0 align-middle">
          <thead>
            <tr>
              <th style="width: 160px;">Time (UTC)</th>
              <th style="width: 90px;">Source</th>
              <th style="width: 160px;">Event</th>
              <th style="width: 90px;">Status</th>
              <th>Note</th>
              <th style="width: 120px;">Meta</th>
            </tr>
          </thead>
          <tbody>
            {% for e in activity_log %}
              {% set ts = e.at or e.timestamp or e.time %}
              {% set src = e.source or e.provider or '—' %}
              {% set evt = e.event or e.action or '—' %}
              {% set st  = e.status or e.code or e.http_status %}
              <tr>
                <td class="text-nowrap small">{{ ts or '—' }}</td>
                <td class="small">{{ src }}</td>
                <td class="small">{{ evt }}</td>
                <td>
                  {% if st in (200, 'ok', 'OK', 'success', 0) %}
                    <span class="badge bg-success">OK</span>
                  {% elif st %}
                    <span class="badge bg-danger">{{ st }}</span>
                  {% else %}
                    <span class="badge bg-secondary">—</span>
                  {% endif %}
                </td>
                <td class="small">{{ e.note or e.msg or e.message or '' }}</td>
                <td class="text-monospace small">
                  {% if e.meta %}
                    <details>
                      <summary class="text-muted">meta</summary>
                      <pre class="mb-0">{{ e.meta | tojson(indent=2) }}</pre>
                    </details>
                  {% else %}—{% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <div class="p-3 text-muted">No log entries yet.</div>
      {% endif %}
    </div>
  </div>
  
  <!-- Property Info (H) -->
  <div class="card mb-3">
    <div class="card-header">Property Info (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-6"><strong>Property Address</strong> (user): {{ fulladdr }}</div>
        <div class="col-md-6"><strong>Bed/Bath</strong> (Z): {{ details.get('bedrooms') or raw_z.get('beds') or raw_z.get('bedrooms') or prop.beds or "—" }}/{{ details.get('bathrooms') or raw_z.get('baths') or raw_z.get('bathrooms') or prop.baths or "—" }}</div>
        <div class="col-md-6"><strong>Year Built</strong> (Z): {{ details.get('yearBuilt') or raw_z.get('year_built') or prop.year_built or "—" }}</div>
        <div class="col-md-6"><strong>Lot Size (sf)</strong> (M): {{ psize.get('AreaLotSF') or "—" }}</div>
        <div class="col-md-6"><strong>PropertyUseGroup</strong> (M): {{ propuseinfo.get('PropertyUseGroup') or "—" }}</div>
        <div class="col-md-6"><strong>HOA?</strong> (H): {{ marketab.get('hoa') or "—" }}</div>
        <div class="col-md-6"><strong>ParkingGarage</strong> (M): {{ psize.get('ParkingGarage') if psize.get('ParkingGarage') is not none else "—" }}</div>
        <div class="col-md-6"><strong>ParkingGarageArea</strong> (M): {{ psize.get('ParkingGarageArea') or "—" }}</div>
        <div class="col-md-6"><strong>BathCount</strong> (M): {{ roominfo.get('BathCount') or m0.get('BathCount') or "—" }}</div>
        <div class="col-md-6"><strong>BathPartialCount</strong> (M): {{ roominfo.get('BathPartialCount') or m0.get('BathPartialCount') or "—" }}</div>
      </div>
    </div>
  </div>

  <!-- Ownership (H) -->
  <div class="card mb-3">
    <div class="card-header">Ownership (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-6"><strong>Primary Owner</strong> (M): {{ powner.get('Name1Full') }}{% if powner.get('Name2Full') %} / {{ powner.get('Name2Full') }}{% endif %}</div>
        <div class="col-md-6"><strong>Secondary Owner</strong> (M): {{ sowner.get('Name3Full') or "—" }}</div>
        <div class="col-md-6"><strong>Owner's Address</strong> (M): {{ owneraddr.get('Address') }} {{ owneraddr.get('Address2') }} {{ owneraddr.get('City') }} {{ owneraddr.get('State') }} {{ owneraddr.get('PostalCode') }}</div>
        <div class="col-md-6"><strong>Owner Occupied</strong> (C): {{ owner_occupied }}</div>
      </div>
    </div>
  </div>

  <!-- Tax (H) -->
  <div class="card mb-3">
    <div class="card-header">Tax (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-4"><strong>YearAssessed</strong> (M): {{ taxnode.get('YearAssessed') or "—" }}</div>
        <div class="col-md-4"><strong>AssessedValueTotal</strong> (M): {{ taxnode.get('AssessedValueTotal') | currency if taxnode.get('AssessedValueTotal') is not none else "—" }}</div>
        <div class="col-md-4"><strong>TaxBilledAmount</strong> (M): {{ taxnode.get('TaxBilledAmount') | currency if taxnode.get('TaxBilledAmount') is not none else "—" }}</div>
      </div>
    </div>
  </div>

  <!-- Title (H) -->
  <div class="card mb-3">
    <div class="card-header">Title (H)</div>
    <div class="card-body">
      <div class="row g-2">
        <div class="col-md-12"><strong>LegalDescription</strong> (M): {{ legal.get('LegalDescription') or "—" }}</div>
        <div class="col-md-4"><strong>County</strong> (M): {{ legal.get('County') or parcel.get('County') or "—" }}</div>
        <div class="col-md-4"><strong>Subdivision</strong> (M): {{ legal.get('Subdivision') or "—" }}</div>
        <div class="col-md-2"><strong>Block1</strong> (M): {{ legal.get('Block1') or "—" }}</div>
        <div class="col-md-2"><strong>LotNumber1</strong> (M): {{ legal.get('LotNumber1') or "—" }}</div>
      </div>
    </div>
  </div>

  <!-- Mortgage Info (H) -->
  <div class="card mb-3">
    <div class="card-header">Mortgage Info (H)</div>
    <div class="card-body">
      {% if latest %}
        <div class="row g-2">
          <div class="col-md-6"><strong>Mortgage1 – TermDate</strong> (M): {{ m1.get('TermDate') or "—" }}</div>
          <div class="col-md-6"><strong>Mortgage1 – RecordingDate</strong> (M): {{ m1.get('RecordingDate') or "—" }}</div>
          <div class="col-md-6"><strong>Mortgage1 – Amount</strong> (M):
            {% if m1.get('Amount') %}{{ (m1.get('Amount')|int) | currency }}{% else %}—{% endif %}
          </div>
          <div class="col-md-6"><strong>Mortgage1 – LenderFullName</strong> (M): {{ m1.get('LenderFullName') or "—" }}</div>
          <div class="col-md-6"><strong>PrimaryGrantor – Name1Full</strong> (M): {{ grantor.get('Name1Full') or "—" }}</div>
          <div class="col-md-6"><strong>PrimaryGrantee – Name1Full</strong> (M): {{ grantee.get('Name1Full') or "—" }}</div>
        </div>
        <div class="text-muted small mt-2">Latest deed by RecordingDate: {{ latest_date or "—" }}</div>
      {% else %}
        <div class="text-muted">No deed records available.</div>
      {% endif %}
    </div>
  </div>

  <!-- Sale Info (H) -->
  <div class="card mb-3">
    <div class="card-header">Sale Info (H)</div>
    <div class="card-body">
      {% set sale_last_date = m_saleinfo.get('AssessorLastSaleDate') %}
      {% set sale_last_amt  = m_saleinfo.get('AssessorLastSaleAmount') %}
      <div class="row g-2">
        <div class="col-md-6"><strong>AssessorLastSaleDate</strong> (M): {{ sale_last_date or "—" }}</div>
        <div class="col-md-6"><strong>AssessorLastSaleAmount</strong> (M): {{ sale_last_amt | currency if sale_last_amt is not none else "—" }}</div>
      </div>
    </div>
  </div>

  <!-- Estimates (H) -->
<div class="card mb-3">
  <div class="card-header">Estimates (H)</div>
  <div class="card-body">
    <div class="row g-2">
      <div class="col-md-3"><strong>ATTOM AVM</strong>:
        {{ ax.get('value') | currency if ax.get('value') is not none else "—" }}
        {% if ax.get('low') and ax.get('high') %}
          <span class="text-muted"> ({{ ax.get('low')|currency }}–{{ ax.get('high')|currency }})</span>
        {% endif %}
        {% if ax.get('as_of') %}
          <span class="badge bg-light text-muted ms-1">as of {{ ax.get('as_of') }}</span>
        {% endif %}
      </div>

      <div class="col-md-3"><strong>ATTOM Rent AVM</strong>:
        {{ rx.get('value') | currency if rx.get('value') is not none else "—" }}
        {% if rx.get('low') and rx.get('high') %}
          <span class="text-muted"> ({{ rx.get('low')|currency }}–{{ rx.get('high')|currency }})</span>
        {% endif %}
        {% if rx.get('as_of') %}
          <span class="badge bg-light text-muted ms-1">as of {{ rx.get('as_of') }}</span>
        {% endif %}
      </div>

      <div class="col-md-3"><strong>Zestimate</strong> (Z):
        {{ raw_z.get('zestimate') | currency if raw_z.get('zestimate') is not none else "—" }}
      </div>

      <div class="col-md-3"><strong>Melissa AVM</strong>:
        {{ mx.get('value') | currency if mx.get('value') is not none else "—" }}
        {% if mx.get('low') and mx.get('high') %}
          <span class="text-muted"> ({{ mx.get('low')|currency }}–{{ mx.get('high')|currency }})</span>
        {% endif %}
        {% if mx.get('as_of') %}
          <span class="badge bg-light text-muted ms-1">as of {{ mx.get('as_of') }}</span>
        {% endif %}
      </div>
    </div>

    <div class="row g-2 mt-2">
      <div class="col-md-3"><span class="text-muted small">
        {% if ax.get('as_of') %}AVM as of {{ ax.get('as_of') }}{% endif %}
        {% if ax.get('confidence') %} · conf {{ ax.get('confidence') }}{% endif %}
      </span></div>
      <div class="col-md-3"><span class="text-muted small">
        {% if rx.get('as_of') %}Rent AVM as of {{ rx.get('as_of') }}{% endif %}
      </span></div>

      <div class="col-md-3"><strong>Estimated Repairs</strong> (C):
        {{ est_repairs if est_repairs else "—" }}
      </div>

      <div class="col-md-3"><strong>Estimated ARV</strong> (C):
        {% set est_arv = ax.get('value')
                         or raw_z.get('zestimate')
                         or mx.get('value')
                         or taxnode.get('AssessedValueTotal') %}
        {{ est_arv | currency if est_arv is not none else "—" }}
      </div>
    </div>
  </div>
</div>



      <div class="row g-2 mt-2">
        <div class="col-md-3"><strong>Estimated Melissa Value</strong> (M): {{ valuation.get('EstimatedValue') | currency if valuation.get('EstimatedValue') is not none else (taxnode.get('AssessedValueTotal') | currency if taxnode.get('AssessedValueTotal') is not none else "—") }}</div>
        <div class="col-md-3"><strong>Estimated Repairs</strong> (C): {{ est_repairs if est_repairs else "—" }}</div>
        <div class="col-md-3"><strong>Estimated ARV</strong> (C): {{ est_arv | currency if est_arv is not none else "—" }}</div>
      </div>
    </div>
  </div>

{# ---------- Comps (filtered) ---------- #}
{% set comps = comps_list or [] %}
<div class="card mb-4">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Comps (≤ 6mo, ≤ 0.5mi, ±15% sqft, ±5yr{% if comps and comps[0].subdivision %}, same subdivision{% endif %})</span>
    <span class="badge bg-light text-muted">{{ comps|length }} matches</span>
  </div>
  <div class="card-body p-0">
    {% if comps %}
      <table class="table table-sm mb-0 align-middle">
        <thead>
          <tr>
            <th style="width:38%;">Address</th>
            <th style="width:14%;">Sale Date</th>
            <th style="width:14%;">Price</th>
            <th style="width:8%;">Beds</th>
            <th style="width:8%;">Baths</th>
            <th style="width:10%;">Sqft</th>
            <th style="width:8%;">Yr</th>
          </tr>
        </thead>
        <tbody>
          {% for c in comps[:10] %}
            <tr>
              <td class="small">{{ c.address }}</td>
              <td class="small">{{ c.saleDate or '—' }}</td>
              <td class="small">{% if c.price is number %}{{ c.price|currency }}{% else %}—{% endif %}</td>
              <td class="small">{{ c.beds if c.beds is not none else '—' }}</td>
              <td class="small">{{ c.baths if c.baths is not none else '—' }}</td>
              <td class="small">{{ c.sqft if c.sqft is not none else '—' }}</td>
              <td class="small">{{ c.yearBuilt if c.yearBuilt is not none else '—' }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      <div class="p-2 text-muted small">Showing up to 10 best comps.</div>
    {% else %}
      <div class="p-3 text-muted">No comps matched the rules. Try widening tolerance or refresh ATTOM.</div>
    {% endif %}
  </div>
</div>



{% endblock %}
