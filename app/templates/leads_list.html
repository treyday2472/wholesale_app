{% extends "base.html" %}
{% block title %}Leads{% endblock %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h2 class="mb-0">Leads</h2>
  <a class="btn btn-primary" href="{{ url_for('main.lead_new_step1') }}">+ Add Lead</a>
</div>

<form class="row g-2 mb-3" method="GET" action="{{ url_for('main.leads_list') }}">
  <div class="col-md-6">
    <input name="q"
           class="form-control"
           placeholder="Search name, phone, email, address, source"
           value="{{ q or '' }}">
  </div>
  <div class="col-md-3">
    <select name="status" class="form-select">
      {% for s in statuses %}
        <option value="{{ s }}" {% if status==s %}selected{% endif %}>
          {{ s if s else "All statuses" }}
        </option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <button class="btn btn-outline-light w-100" type="submit">Filter</button>
  </div>
</form>

{# ---- helpers ---- #}
{% macro status_badge_class(s) -%}
  {# Normalize once #}
  {%- set t = (s or '')|lower -%}
  {# quick buckets by prefix/keywords #}
  {%- if t == 'new lead' -%}bg-info
  {%- elif 'contacted' in t -%}bg-primary
  {%- elif 'inspection' in t -%}bg-warning
  {%- elif 'offer' in t and ('accepted' in t or 'under contract' in t) -%}bg-success
  {%- elif 'offer' in t -%}bg-secondary
  {%- elif 'contract: sent' in t or 'title' in t or 'marketing' in t or 'showing' in t or 'assignment' in t or 'closed' in t -%}bg-success
  {%- elif t.startswith('x') -%}bg-danger
  {%- else -%}bg-light text-dark
  {%- endif -%}
{%- endmacro %}

<div class="table-responsive">
  <table class="table table-dark table-striped align-middle">
    <thead>
      <tr>
        <th style="width:70px;">ID</th>
        <th>Seller</th>
        <th>Phone</th>
        <th>Address</th>
        <th style="width:220px;">Status</th>
        <th>Source</th>
        <th style="width:300px;" class="text-end">Actions</th>
      </tr>
    </thead>
    <tbody>
    {% if leads %}
      {% for lead in leads %}
        {% set pid = lead.property_id if lead.property_id is defined else None %}
        <tr>
          <td>#{{ lead.id }}</td>

          {# FIX: trim the whole concatenation, not just last token #}
          <td>{{ ((lead.seller_first_name or '') ~ ' ' ~ (lead.seller_last_name or '')) | trim or '—' }}</td>

          <td>
            {% if lead.phone %}
              {% set normalized = (lead.phone | replace(' ', '') | replace('(', '') | replace(')', '') | replace('-', '')) %}
              <a class="link-light text-decoration-none" href="tel:{{ normalized }}">{{ lead.phone }}</a>
            {% else %}
              —
            {% endif %}
          </td>

          <td>{{ lead.address or '—' }}</td>

          <td>
            {% set lbl = lead.lead_status or 'New Lead' %}
            <span class="badge {{ status_badge_class(lbl) }}">{{ lbl }}</span>
          </td>

          <td>{{ lead.lead_source or '' }}</td>

          <td class="text-end text-nowrap">
            <div class="btn-group" role="group">
              <a class="btn btn-sm btn-light"
                 href="{{ url_for('main.lead_detail', lead_id=lead.id) }}">
                Open
              </a>

              {# Offer: create tied to this lead (and property if present) #}
              {% if pid %}
                <a class="btn btn-sm btn-primary"
                   href="{{ url_for('offers.new_offer', lead_id=lead.id, property_id=pid) }}">
                  Offer
                </a>
              {% else %}
                <a class="btn btn-sm btn-primary"
                   href="{{ url_for('offers.new_offer', lead_id=lead.id) }}">
                  Offer
                </a>
              {% endif %}

              {# Property: go to specific property if linked, else search properties by address #}
              {% if pid %}
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ url_for('main.property_detail', property_id=pid) }}">
                  Property
                </a>
              {% else %}
                <a class="btn btn-sm btn-outline-secondary"
                   href="{{ url_for('main.properties_list', q=(lead.address or '')) }}">
                  Find Property
                </a>
              {% endif %}
            </div>

            <form method="POST"
                  action="{{ url_for('main.delete_lead', lead_id=lead.id) }}"
                  class="d-inline-block ms-2"
                  onsubmit="return confirm({{ (
                    'Delete lead #' ~ lead.id ~ ' — ' ~ ((lead.seller_first_name or '') ~ ' ' ~ (lead.seller_last_name or '')) ~ '?'
                  ) | tojson }});">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>


          </td>
        </tr>
      {% endfor %}
    {% else %}
        <tr><td colspan="7" class="text-center">No leads found.</td></tr>
    {% endif %}
    </tbody>
  </table>
</div>

{% endblock %}