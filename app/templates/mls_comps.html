{% extends "base.html" %}
{% block content %}
<h2>MLS Comps for {{ prop.full_address or prop.address }}</h2>

<p class="text-muted">
  VA: Enter comps from PropStream/MLS. Add 3â€“8 comps, then click "Submit MLS Comps for AI Analysis".
</p>

<form method="POST" class="mb-4">
  <div class="row g-2">
    <div class="col-md-6">
      <label class="form-label">Comp Address *</label>
      <input type="text" name="comp_address" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Sale Price *</label>
      <input type="number" step="0.01" name="sale_price" class="form-control" required>
    </div>
    <div class="col-md-3">
      <label class="form-label">Sale Date *</label>
      <input type="date" name="sale_date" class="form-control" required>
    </div>
  </div>

  <div class="row g-2 mt-2">
    <div class="col-md-2">
      <label class="form-label">SQFT</label>
      <input type="number" step="1" name="sqft" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Beds</label>
      <input type="number" step="1" name="beds" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Baths</label>
      <input type="number" step="0.5" name="baths" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Year Built</label>
      <input type="number" step="1" name="year_built" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Lot Size (sqft)</label>
      <input type="number" step="1" name="lot_size" class="form-control">
    </div>
    <div class="col-md-2">
      <label class="form-label">Distance (miles)</label>
      <input type="number" step="0.01" name="distance" class="form-control">
    </div>
  </div>

  <div class="row g-2 mt-2">
    <div class="col-md-4">
      <label class="form-label">Photo URL</label>
      <input type="url" name="photo_url" class="form-control">
    </div>
    <div class="col-md-3">
      <label class="form-label">Source</label>
      <select name="mls_source" class="form-select">
        <option value="PropStream">PropStream</option>
        <option value="Privy">Privy</option>
        <option value="MLS">Direct MLS</option>
        <option value="Other">Other</option>
      </select>
    </div>
    <div class="col-md-5">
      <label class="form-label">Condition Notes</label>
      <input type="text" name="condition_notes" class="form-control" placeholder="e.g. 'needs full rehab', 'turnkey'">
    </div>
  </div>

  <button type="submit" class="btn btn-primary mt-3">Add Comp</button>
  <a href="{{ url_for('main.property_detail', property_id=prop.id) }}" class="btn btn-secondary mt-3">Back to Property</a>
</form>

<hr>

<h4>Current MLS Comps ({{ mls_comps|length }})</h4>

{% if mls_comps %}
  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>Address</th>
        <th>Sale Price</th>
        <th>Sale Date</th>
        <th>Sqft</th>
        <th>Beds/Baths</th>
        <th>Dist (mi)</th>
        <th>Source</th>
        <th>Notes</th>
      </tr>
    </thead>
    <tbody>
      {% for c in mls_comps %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ c.address or c["address"] }}</td>
        <td>${{ "{:,.0f}".format(c.price or c["price"] or 0) }}</td>
        <td>{{ c.saleDate or c["saleDate"] }}</td>
        <td>{{ c.sqft or c["sqft"] }}</td>
        <td>{{ (c.beds or c["beds"]) }} / {{ (c.baths or c["baths"]) }}</td>
        <td>{{ c.distance or c["distance"] }}</td>
        <td>{{ c.source or c["source"] }}</td>
        <td>{{ c.conditionNotes or c["conditionNotes"] }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <form method="POST" action="{{ url_for('main.mls_comps_finalize', property_id=prop.id) }}" class="mt-3">
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <label class="col-form-label">Top K comps for AI:</label>
      </div>
      <div class="col-auto">
        <input type="number" name="k" value="6" min="1" max="{{ mls_comps|length }}" class="form-control form-control-sm" style="width: 80px;">
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-success btn-sm">
          Submit MLS Comps for AI Analysis
        </button>
      </div>
    </div>
  </form>
{% else %}
  <p class="text-muted">No MLS comps entered yet.</p>
{% endif %}

<hr>

<h4>Zillow Comps ({{ comps|length }})</h4>

{% if comps %}
  <table class="table table-sm table-striped align-middle">
    <thead>
      <tr>
        <th>#</th>
        <th>Address</th>
        <th>Price</th>
        <th>Sale/List Date</th>
        <th>Sqft</th>
        <th>Beds/Baths</th>
        <th>Distance (mi)</th>
        <th>Source</th>
      </tr>
    </thead>
    <tbody>
      {% for c in comps %}
      <tr>
        <td>{{ loop.index }}</td>
        <td>{{ c.address or c["address"] }}</td>
        <td>
          {% set price = c.sale_price or c.list_price or c.zestimate or c["sale_price"] or c["list_price"] or c["zestimate"] %}
          ${{ "{:,.0f}".format(price or 0) }}
        </td>
        <td>{{ c.sale_date or c.list_date or c["sale_date"] or c["list_date"] }}</td>
        <td>{{ c.sqft or c["sqft"] }}</td>
        <td>{{ (c.beds or c["beds"]) }} / {{ (c.baths or c["baths"]) }}</td>
        <td>{{ c.distance or c["distance"] }}</td>
        <td>{{ c.source or c["source"] or "Zillow" }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p class="text-muted">No Zillow comps found for this property.</p>
{% endif %}



{% endblock %}

