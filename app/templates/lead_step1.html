{% extends "base.html" %}
{% block content %}

<h2 class="mb-3">Step 1: Your Contact & Property Address</h2>

<form method="POST">
  {{ form.hidden_tag() }}

  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.seller_first_name.label(class="form-label") }}
      {{ form.seller_first_name(class="form-control", placeholder="First name") }}
    </div>
    <div class="col-md-6 mb-3">
      {{ form.seller_last_name.label(class="form-label") }}
      {{ form.seller_last_name(class="form-control", placeholder="Last name") }}
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.email.label(class="form-label") }}
      {{ form.email(class="form-control", placeholder="name@email.com") }}
    </div>
    <div class="col-md-6 mb-3">
      {{ form.phone.label(class="form-label") }}
      {{ form.phone(class="form-control", placeholder="(555) 555-5555") }}
    </div>
  </div>

  <div class="mb-3">
    {{ form.address.label(class="form-label") }}
    {{ form.address(class="form-control", id="autocomplete-address", placeholder="Start typing your address") }}
    <div class="form-text">Address autocomplete enabled.</div>
  </div>

  {{ form.full_address() }}
  {{ form.lat() }}
  {{ form.lng() }}

  {{ form.submit(class="btn btn-primary") }}
</form>

<script>
  const KEY = "{{ GOOGLE_MAPS_API_KEY }}";

  function initAutocomplete() {
    const input = document.getElementById('autocomplete-address');
    if (!input) return;

    // Use the classic Autocomplete (still supported)
    /* global google */
    const ac = new google.maps.places.Autocomplete(input, {
      types: ['address'],
      componentRestrictions: { country: ['us'] }
    });

    ac.addListener('place_changed', () => {
      const place = ac.getPlace();
      const full  = document.querySelector('input[name="full_address"]');
      const lat   = document.querySelector('input[name="lat"]');
      const lng   = document.querySelector('input[name="lng"]');

      // Save formatted address
      if (place && place.formatted_address && full) {
        full.value = place.formatted_address;
      }
      // Save lat/lng if available
      if (place && place.geometry && place.geometry.location) {
        if (lat) lat.value = place.geometry.location.lat();
        if (lng) lng.value = place.geometry.location.lng();
      }
    });
  }

  if (!KEY) {
    console.warn('GOOGLE_MAPS_API_KEY missing; autocomplete will not load.');
  } else {
    const s = document.createElement('script');
    s.src = `https://maps.googleapis.com/maps/api/js?key=${KEY}&libraries=places&callback=initAutocomplete`;
    s.async = true;
    s.defer = true;
    document.head.appendChild(s);
  }
</script>


{% endblock %}
