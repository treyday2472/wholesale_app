{% extends "base.html" %}
{% block content %}
<h2>Step 1: Your Contact & Property Address</h2>
<form method="POST">
  {{ form.hidden_tag() }}

  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.seller_first_name.label(class="form-label") }}
      {{ form.seller_first_name(class="form-control", placeholder="First name") }}
    </div>
    <div class="col-md-6 mb-3">
      {{ form.seller_last_name.label(class="form-label") }}
      {{ form.seller_last_name(class="form-control", placeholder="Last name") }}
    </div>
  </div>

  <div class="row">
    <div class="col-md-6 mb-3">
      {{ form.email.label(class="form-label") }}
      {{ form.email(class="form-control", placeholder="name@email.com") }}
    </div>
    <div class="col-md-6 mb-3">
      {{ form.phone.label(class="form-label") }}
      {{ form.phone(class="form-control", placeholder="(555) 555-5555") }}
    </div>
  </div>

  <div class="mb-3">
    {{ form.address.label(class="form-label") }}
    {{ form.address(class="form-control", id="autocomplete-address", placeholder="Start typing your address") }}
    <div class="form-text">Address autocomplete enabled.</div>
  </div>

  <!-- Hidden fields populated by Places API -->
  {{ form.full_address() }}
  {{ form.lat() }}
  {{ form.lng() }}

  {{ form.submit(class="btn btn-primary") }}
</form>

<!-- Google Places Autocomplete -->
<script>
  // ⚠️ Strongly recommend restricting this key to your localhost referrers in Google Cloud.
  const GOOGLE_PLACES_API_KEY = "AIzaSyDg2DddC04zDd2gJadBB_tKQCFH17rrVvU";

  function initAutocomplete() {
    const input = document.getElementById('autocomplete-address');
    if (!input) return;

    // Prevent Enter from submitting before a place is selected
    input.addEventListener('keydown', (e) => { if (e.key === 'Enter') e.preventDefault(); });

    /* global google */
    const autocomplete = new google.maps.places.Autocomplete(input, {
      types: ['address'],
      componentRestrictions: { country: ["us"] }
    });

    // Only request what we need (quota-friendly)
    if (autocomplete.setFields) {
      autocomplete.setFields(['formatted_address','geometry','address_components']);
    }

    autocomplete.addListener('place_changed', () => {
      const place = autocomplete.getPlace();
      const full = document.querySelector('input[name="full_address"]');
      const lat  = document.querySelector('input[name="lat"]');
      const lng  = document.querySelector('input[name="lng"]');

      if (!place || !place.geometry) {
        // user typed but didn't pick a suggestion; still submit typed value
        if (full) full.value = input.value;
        return;
      }

      if (full) full.value = place.formatted_address || input.value;
      if (lat)  lat.value  = place.geometry.location.lat();
      if (lng)  lng.value  = place.geometry.location.lng();
    });
  }

  const s = document.createElement('script');
  s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_PLACES_API_KEY}&libraries=places&callback=initAutocomplete`;
  s.async = true;
  s.defer = true;
  document.body.appendChild(s);
</script>
{% endblock %}
